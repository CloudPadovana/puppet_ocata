#
## When we also provide SSL we have to listen to the
## the HTTPS port in addition.
##
#
Listen 443

##
###  SSL Global Context
###
###  All SSL configuration in this context applies both to
###  the main server and all SSL-enabled virtual hosts.
###
#
##   Pass Phrase Dialog:
##   Configure the pass phrase gathering process.
##   The filtering dialog program (`builtin' is a internal
##   terminal dialog) has to provide the pass phrase on stdout.
#SSLPassPhraseDialog exec:/usr/libexec/httpd-ssl-pass-dialog
#
##   Inter-Process Session Cache:
##   Configure the SSL Session Cache: First the mechanism
##   to use and second the expiring timeout (in seconds).
#SSLSessionCache         shmcb:/run/httpd/sslcache(512000)
#SSLSessionCacheTimeout  300
#
##   Pseudo Random Number Generator (PRNG):
##   Configure one or more sources to seed the PRNG of the
##   SSL library. The seed data should be of good random quality.
##   WARNING! On some platforms /dev/random blocks if not enough entropy
##   is available. This means you then cannot use the /dev/random device
##   because it would lead to very long connection times (as long as
##   it requires to make more entropy available). But usually those
##   platforms additionally provide a /dev/urandom device which doesn't
##   block. So, if available, use this one instead. Read the mod_ssl User
##   Manual for more details.
#SSLRandomSeed startup file:/dev/urandom  256
#SSLRandomSeed connect builtin
##SSLRandomSeed startup file:/dev/random  512
##SSLRandomSeed connect file:/dev/random  512
##SSLRandomSeed connect file:/dev/urandom 512
#
##
## Use "SSLCryptoDevice" to enable any supported hardware
## accelerators. Use "openssl engine -v" to list supported
## engine names.  NOTE: If you enable an accelerator and the
## server does not start, consult the error logs and ensure
## your accelerator is functioning properly.
##
#
SSLCryptoDevice builtin
#SSLCryptoDevice ubsec
#
###
### SSL Virtual Host Context
###
#

<VirtualHost _default_:443>
    ServerName <%=@site_fqdn%>:443
    UseCanonicalName On

    RedirectMatch permanent  ^/$ /dashboard
    <Files ~ "\.(cgi|shtml|phtml|php3?)$">
        SSLOptions +StdEnvVars
    </Files>
    <Directory "/var/www/cgi-bin">
        SSLOptions +StdEnvVars
    </Directory>

    BrowserMatch "MSIE [2-5]" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
    
    ErrorLog "/var/log/httpd/horizon_error.log"
    ServerSignature Off
    CustomLog "/var/log/httpd/horizon_access.log" combined 

    SSLEngine on
    SSLProtocol all -SSLv2
    SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5:!SEED:!IDEA
    SSLCertificateFile <%=@host_cert%>
    SSLCertificateKeyFile <%=@host_key%>

    WSGIDaemonProcess apache group=apache processes=3 threads=10 user=apache
    WSGIProcessGroup apache
    WSGISocketPrefix run/wsgi
    WSGIScriptAlias /dashboard "/usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi"

    Alias /dashboard/static /usr/share/openstack-dashboard/static

    <Directory /usr/share/openstack-dashboard/openstack_dashboard/wsgi>
      Options All
      AllowOverride All
      Require all granted
    </Directory>

    <Directory /usr/share/openstack-dashboard/static>
      Options All
      AllowOverride All
      Require all granted
    </Directory>

<% if @enable_aai_ext and @enable_shib -%>
    WSGIScriptAlias /dashboard-infn "/usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi"

    <Location /dashboard-infn>
        AuthType shibboleth
        ShibRequestSetting requireSession 1
        require shib-session
        ShibRequestSetting applicationId default
        ShibRequestSetting target https://<%=@site_fqdn%>/dashboard-infn/auth/login/
        ShibRequestSetting entityID <%=@infnaai_ent_id%>
    </Location>
<% end -%>

</VirtualHost>
